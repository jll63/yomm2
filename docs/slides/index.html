<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <title>yomm2</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="https://unpkg.com/reveal.js@3.9.2//css/reset.css">
  <link rel="stylesheet" href="https://unpkg.com/reveal.js@3.9.2//css/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="https://unpkg.com/reveal.js@3.9.2//css/theme/beige.css" id="theme">
  <!-- Printing and PDF exports -->
  <script>
    var link = document.createElement( 'link' );
    link.rel = 'stylesheet';
    link.type = 'text/css';
    link.href = window.location.search.match( /print-pdf/gi ) ? 'https://unpkg.com/reveal.js@3.9.2//css/print/pdf.css' : 'https://unpkg.com/reveal.js@3.9.2//css/print/paper.css';
    document.getElementsByTagName( 'head' )[0].appendChild( link );
  </script>
  <!--[if lt IE 9]>
  <script src="https://unpkg.com/reveal.js@3.9.2//lib/js/html5shiv.js"></script>
  <![endif]-->
</head>
<body>
  <div class="reveal">
    <div class="slides">


<section id="open-is-good" class="slide level2">
<h2>Open Is Good</h2>
<p><br/><br/></p>
<p>YOMM2: Fast, Orthogonal Open (Multi) Methods</p>
<p><br/><br/></p>
<p><small> Jean-Louis Leroy - jl@leroy.nyc<br/> </small></p>
</section>
<section>
<section id="case-study-ast" class="title-slide slide level1">
<h1>Case Study: AST</h1>

</section>
<section id="case-study-ast-1" class="slide level2">
<h2>Case Study: AST</h2>
<p><br/></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="kw">struct</span> Node {</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a>    <span class="kw">virtual</span> <span class="dt">double</span> value() = <span class="dv">0</span>;</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a>};</span></code></pre></div>
<p>const, memory management, etc, omitted<br/> code formatted to fit slide</p>
</section>
<section id="case-study-ast-2" class="slide level2">
<h2>Case Study: AST</h2>
<p><br/></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="kw">struct</span> Number : Node {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a>  Number(<span class="dt">double</span> value) : val(value ) { }</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>  <span class="dt">double</span> value() <span class="kw">override</span> {</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>    <span class="cf">return</span> val;</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>  }</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a>  <span class="dt">double</span> val;</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a>};</span></code></pre></div>
</section>
<section id="case-study-ast-3" class="slide level2">
<h2>Case Study: AST</h2>
<p><br/></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="kw">struct</span> Plus : Node {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a>    Plus(Node&amp; left, Node&amp; right)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a>    : left(left), right(right) { }</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a>  <span class="dt">double</span> value() <span class="kw">override</span> {</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a>    <span class="cf">return</span> left.value() + right.value();</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a>  }</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a>  Node &amp;left, &amp;right;</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a>};</span></code></pre></div>
</section>
<section id="case-study-ast-4" class="slide level2">
<h2>Case Study: AST</h2>
<p><br/></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="kw">struct</span> Times : Node {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>    Times(Node&amp; left, Node&amp; right)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a>    : left(left), right(right) { }</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a>    <span class="dt">double</span> value() <span class="kw">override</span> {</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a>        <span class="cf">return</span> left.value() * right.value();</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a>    }</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a>    Node &amp;left, &amp;right;</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a>};</span></code></pre></div>
</section>
<section id="case-study-ast-5" class="slide level2">
<h2>Case Study: AST</h2>
<p><br/></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="dt">int</span> main() {</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a>    Node* expr =</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a>        <span class="kw">new</span> Times(</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a>            *<span class="kw">new</span> Number(<span class="dv">2</span>),</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a>            *<span class="kw">new</span> Plus(*<span class="kw">new</span> Number(<span class="dv">3</span>), *<span class="kw">new</span> Number(<span class="dv">4</span>)));</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a>    cout &lt;&lt; expr-&gt;value() &lt;&lt; <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>; <span class="co">// 14</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true"></a>    <span class="cf">return</span> <span class="dv">0</span>;</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true"></a>}</span></code></pre></div>
</section>
<section id="case-study-ast-6" class="slide level2">
<h2>Case Study: AST</h2>
<p><br/></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="dt">int</span> main() {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a>    Node* expr =</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a>        <span class="kw">new</span> Times(</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a>            *<span class="kw">new</span> Number(<span class="dv">2</span>),</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a>            *<span class="kw">new</span> Plus(*<span class="kw">new</span> Number(<span class="dv">3</span>), *<span class="kw">new</span> Number(<span class="dv">4</span>)));</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a>    cout &lt;&lt; <span class="co">/* RPN */</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a>         &lt;&lt; <span class="st">&quot; = &quot;</span> &lt;&lt; expr-&gt;value() &lt;&lt; <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>;</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a>    <span class="co">// 2 3 4 * + = 14</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true"></a>    <span class="cf">return</span> <span class="dv">0</span>;</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true"></a>}</span></code></pre></div>
</section>
<section id="ast-add-a-virtual-function" class="slide level2">
<h2>AST: Add a Virtual Function?</h2>
<div class="sourceCode" id="cb7"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="kw">struct</span> Node {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a>    <span class="co">// as before</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a>    <span class="kw">virtual</span> string toRPN() = <span class="dv">0</span>;</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a>};</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a><span class="kw">struct</span> Plus : Node {</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true"></a>    <span class="co">// as before</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true"></a>  string toRPN() <span class="kw">override</span> {</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true"></a>    <span class="cf">return</span> left.toRPN() + <span class="st">&quot; &quot;</span> + right.toRPN() + <span class="st">&quot; +&quot;</span>;</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true"></a>  }</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true"></a>};</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true"></a><span class="co">// same for Number and Times</span></span></code></pre></div>
<p>banana -&gt; gorilla -&gt; jungle</p>
</section>
<section id="ast-type-switch" class="slide level2">
<h2>AST: Type Switch?</h2>
<div class="sourceCode" id="cb8"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a>string toRPN(Node&amp; node) {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a>    <span class="cf">if</span> (<span class="kw">auto</span> expr = <span class="kw">dynamic_cast</span>&lt;Number*&gt;(&amp;node)) {</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a>        <span class="cf">return</span> to_string(expr-&gt;value());</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a>    } <span class="cf">else</span> <span class="cf">if</span> (<span class="kw">auto</span> expr = <span class="kw">dynamic_cast</span>&lt;Plus*&gt;(&amp;node)) {</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a>        <span class="cf">return</span> toRPN(expr-&gt;left) + <span class="st">&quot; &quot;</span> +</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a>            toRPN(expr-&gt;right) + <span class="st">&quot; +&quot;</span>;</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a>    } <span class="cf">else</span> <span class="cf">if</span> (<span class="kw">auto</span> expr = <span class="kw">dynamic_cast</span>&lt;Times*&gt;(&amp;node)) {</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true"></a>        <span class="cf">return</span> toRPN(expr-&gt;left) + <span class="st">&quot; &quot;</span> +</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true"></a>            toRPN(expr-&gt;right) + <span class="st">&quot; *&quot;</span>;</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true"></a>    }</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true"></a>    <span class="cf">throw</span> runtime_error(<span class="st">&quot;unknown node type&quot;</span>);</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true"></a>}</span></code></pre></div>
<p>needs modification each time a new Node subtype is added</p>
</section>
<section id="ast-visitor" class="slide level2">
<h2>AST: Visitor?</h2>
<div class="sourceCode" id="cb9"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a><span class="kw">struct</span> Node {</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a>    <span class="co">// as before</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a>    <span class="kw">struct</span> Visitor {</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="dt">void</span> accept(Number&amp; expr) = <span class="dv">0</span>;</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="dt">void</span> accept(Plus&amp; expr) = <span class="dv">0</span>;</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true"></a>        <span class="kw">virtual</span> <span class="dt">void</span> accept(Times&amp; expr) = <span class="dv">0</span>;</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true"></a>    };</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true"></a>    <span class="kw">virtual</span> <span class="dt">void</span> visit(Visitor&amp; viz) = <span class="dv">0</span>;</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true"></a>};</span></code></pre></div>
</section>
<section id="ast-visitor-1" class="slide level2">
<h2>AST: Visitor?</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="kw">struct</span> Number : Node {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a>  <span class="co">// as before</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a>  <span class="dt">void</span> visit(Visitor&amp; viz) <span class="kw">override</span> { viz.accept(*<span class="kw">this</span>); }</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a>};</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true"></a><span class="kw">struct</span> Plus : Node {</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true"></a>  <span class="dt">void</span> visit(Visitor&amp; viz) <span class="kw">override</span> { viz.accept(*<span class="kw">this</span>); }</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true"></a>};</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true"></a><span class="kw">struct</span> Times : Node {</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true"></a>    <span class="dt">void</span> visit(Visitor&amp; viz) <span class="kw">override</span> { viz.accept(*<span class="kw">this</span>); }</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true"></a>};</span></code></pre></div>
</section>
<section id="ast-visitor-2" class="slide level2">
<h2>AST: Visitor?</h2>
<div class="sourceCode" id="cb11"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a><span class="kw">struct</span> RPNVisitor : Node::Visitor {</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a>  string result;</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a>  <span class="dt">void</span> accept(Number&amp; expr) {</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a>    result = to_string(expr.val);</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true"></a>  }</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true"></a>  <span class="dt">void</span> accept(Plus&amp; expr) {</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true"></a>    expr.left.visit(*<span class="kw">this</span>);</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true"></a>    string l = result;</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true"></a>    expr.right.visit(*<span class="kw">this</span>);</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true"></a>    result = l + <span class="st">&quot; &quot;</span> + result + <span class="st">&quot; +&quot;</span>;</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true"></a>  }</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true"></a>  <span class="dt">void</span> accept(Times&amp; expr) { ... }</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true"></a>};</span></code></pre></div>
</section>
<section id="ast-visitor-3" class="slide level2">
<h2>AST: Visitor?</h2>
<div class="sourceCode" id="cb12"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a>string toRPN(Node&amp; node) {</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a>  RPNVisitor viz;</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a>  node.visit(viz);</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a>  <span class="cf">return</span> viz.result;</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true"></a>}</span></code></pre></div>
<ul>
<li>lot of work</li>
<li>now it’s difficult to add new types</li>
</ul>
</section>
<section id="ast-function-table" class="slide level2">
<h2>AST: Function Table?</h2>
<div class="sourceCode" id="cb13"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a><span class="kw">using</span> RPNFormatter = string (*)(Node&amp;);</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a>unordered_map&lt;type_index, RPNFormatter&gt; RPNformatters;</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true"></a>string toRPN(Node&amp; node) {</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true"></a>  <span class="cf">return</span> RPNformatters[<span class="kw">typeid</span>(node)](node);</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true"></a>}</span></code></pre></div>
</section>
<section id="ast-function-table-1" class="slide level2">
<h2>AST: Function Table?</h2>
<div class="sourceCode" id="cb14"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="kw">namespace</span> { <span class="kw">struct</span> Init {</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a>  Init() {</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a>    RPNformatters[<span class="kw">typeid</span>(Number)] = [](Node&amp; node) {</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true"></a>     <span class="cf">return</span> to_string(<span class="kw">static_cast</span>&lt;Number&amp;&gt;(node).val); };</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true"></a>    RPNformatters[<span class="kw">typeid</span>(Plus)] = [](Node&amp; node) {</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true"></a>     <span class="kw">auto</span> expr = <span class="kw">static_cast</span>&lt;Plus&amp;&gt;(node);</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true"></a>     <span class="cf">return</span> toRPN(expr.left) + <span class="st">&quot; &quot;</span> + toRPN(expr.right)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true"></a>       + <span class="st">&quot; +&quot;</span>; };</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true"></a>    <span class="co">// same for Time</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true"></a>  }</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true"></a>};</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true"></a>Init init;</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true"></a>} }</span></code></pre></div>
<p>not bad, actually</p>
</section></section>
<section>
<section id="the-expression-problem" class="title-slide slide level1">
<h1>The Expression Problem</h1>

</section>
<section id="the-expression-problem-1" class="slide level2">
<h2>The Expression Problem</h2>
<p><br/><br/></p>
<h3 id="existing-operations-new-types">existing operations += new types</h3>
<h3 id="existing-types-new-operations">existing types += new operations</h3>
</section>
<section id="multi-layer-architectures" class="slide level2">
<h2>Multi-Layer Architectures</h2>
<p><br/><br/></p>
<h3 id="presentation">presentation</h3>
<hr/>
<h3 id="domain">domain</h3>
<hr/>
<h3 id="persistence">persistence</h3>
</section>
<section id="multi-layer-architectures-1" class="slide level2">
<h2>Multi-Layer Architectures</h2>
<p><br/></p>
<ul>
<li><p>presentation: PersonDlg, CriminalCaseDlg</p></li>
<li><p>domain: Person, CriminalCase</p></li>
<li><p>persistence: persist to database, to json…</p></li>
<li><p>cross-cutting concerns</p></li>
</ul>
</section></section>
<section>
<section id="open-methods" class="title-slide slide level1">
<h1>Open Methods</h1>

</section>
<section id="open-methods-1" class="slide level2">
<h2>Open Methods</h2>
<p><br/><br/></p>
<ul>
<li><p>free virtual functions</p></li>
<li><p>existing types += new operations</p></li>
</ul>
</section>
<section id="ast" class="slide level2">
<h2>AST</h2>
<div class="sourceCode" id="cb15"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a><span class="pp">#include </span><span class="im">&lt;yorel/yomm2/keywords.hpp&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true"></a>register_classes(Node, Plus, Times, Number);</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true"></a>declare_method(string, toRPN, (<span class="va">virtual_</span>&lt;Node&amp;&gt;));</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true"></a>define_method(string, toRPN, (Number&amp; expr)) {</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true"></a>  <span class="cf">return</span> to_string(expr.val);</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true"></a>}</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true"></a>define_method(string, toRPN, (Plus&amp; expr)) {</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true"></a>  <span class="cf">return</span> toRPN(expr.left) + <span class="st">&quot; &quot;</span> + toRPN(expr.right) + <span class="st">&quot; +&quot;</span>;</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true"></a>}</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true"></a><span class="co">// same for Times</span></span></code></pre></div>
</section>
<section id="ast-1" class="slide level2">
<h2>AST</h2>
<div class="sourceCode" id="cb16"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a><span class="dt">int</span> main() {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a>  yorel::yomm2::update_methods();</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true"></a>  cout &lt;&lt; toRPN(expr) &lt;&lt; <span class="st">&quot; = &quot;</span> &lt;&lt; expr-&gt;value() &lt;&lt; <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>;</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true"></a>  <span class="co">// 2 3 4 * + = 14</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true"></a>}</span></code></pre></div>
</section>
<section id="ast-what-about-value" class="slide level2">
<h2>AST: what about value?</h2>
<ul>
<li><p><code>value</code> in the node hierarchy =&gt; interpreter</p></li>
<li><p>AST classes should <em>only</em> represent the tree</p></li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a>declare_method(<span class="dt">int</span>, value, (<span class="va">virtual_</span>&lt;Node&amp;&gt;));</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true"></a>define_method(<span class="dt">int</span>, value, (Number&amp; expr)) {</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true"></a>  <span class="cf">return</span> expr.val;</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true"></a>}</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true"></a>define_method(<span class="dt">int</span>, value, (Plus&amp; expr)) {</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true"></a>  <span class="cf">return</span> value(expr.left) + value(expr.right);</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true"></a>}</span></code></pre></div>
</section>
<section id="multiple-dispatch" class="slide level2">
<h2>Multiple Dispatch</h2>
<p>Sometimes useful.</p>
<pre class="text"><code>add(Matrix, Matrix)                 -&gt; Matrix
                                       add all elements
add(DiagonalMatrix, DiagonalMatrix) -&gt; DiagonalMatrix
                                       just add diagonals

fight(Human, Creature, Axe)    -&gt; not agile enough to wield
fight(Warrior, Creature, Axe)  -&gt; chop it into pieces
fight(Warrior, Dragon, Axe)    -&gt; die a honorable death
fight(Human, Dragon, Hands)    -&gt; congratulations! you have just
                                  vanquished a dragon with your
                                  bare hands! (unbelievable,
                                  isn&#39;t it?)</code></pre>
</section>
<section id="syntax" class="slide level2">
<h2>Syntax</h2>
<p><code>virtual_&lt;&gt;</code> denotes parameters taken into consideration when selecting the appropriate specialization</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a>declare_method(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true"></a>  string, fight,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true"></a>  (<span class="va">virtual_</span>&lt;Character&amp;&gt;, <span class="va">virtual_</span>&lt;Creature&amp;&gt;, <span class="va">virtual_</span>&lt;Device&amp;&gt;));</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true"></a>define_method(string, fight, (Human&amp; x, Creature&amp; y, Axe&amp; z)) {</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true"></a>  <span class="cf">return</span> <span class="st">&quot;not agile enough to wield&quot;</span>;</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true"></a>}</span></code></pre></div>
</section>
<section id="selecting-the-right-specialization" class="slide level2">
<h2>Selecting the right specialization</h2>
<p><br/></p>
<ul>
<li><p>works just like selecting from set of overloads (but at runtime!)</p></li>
<li><p>or partial template specialization</p></li>
<li><p>ambiguities can arise</p></li>
</ul>
</section>
<section id="next" class="slide level2">
<h2><code>next</code></h2>
<p>calls the next most specific specialization</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a>register_classes(Animal, Dog, Bulldog);</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true"></a>declare_method(<span class="bu">std::</span>string, kick, (<span class="va">virtual_</span>&lt;Animal&amp;&gt;));</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true"></a>define_method(string, kick, (Dog&amp; dog)) {</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true"></a>  <span class="cf">return</span> <span class="st">&quot;bark&quot;</span>;</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true"></a>}</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true"></a>define_method(string, kick, (Bulldog&amp; dog)) {</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true"></a>    <span class="cf">return</span> next(dog) + <span class="st">&quot; and bite&quot;</span>;</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true"></a>}</span></code></pre></div>
</section></section>
<section>
<section id="is-this-oop" class="title-slide slide level1">
<h1>Is This OOP?</h1>

</section>
<section id="is-this-oop-1" class="slide level2">
<h2>Is This OOP?</h2>
<ul>
<li><p>Simula, Smalltalk, C++/Java/D/…:<br/>message-receiver</p></li>
<li><p>CLOS: rules</p></li>
<li><p>algorithms retake the front stage</p></li>
<li><p>no unnecessary breach of encapsulation</p></li>
</ul>
</section></section>
<section>
<section id="inside-yomm2" class="title-slide slide level1">
<h1>Inside yomm2</h1>
<ul>
<li><p>purely in C++17 (no extra tooling)</p></li>
<li><p>constant time dispatch</p></li>
<li><p>uses tables of function pointers</p></li>
<li><p>object -&gt; dispatch data?</p>
<ul>
<li>perfect integer hash of &amp;type_info</li>
</ul></li>
</ul>
</section>
<section id="a-payroll-application" class="slide level2">
<h2>A Payroll Application</h2>
<ul>
<li><em>Role</em>
<ul>
<li>Employee
<ul>
<li>Manager</li>
</ul></li>
<li>Founder</li>
</ul></li>
<li><em>Expense</em>
<ul>
<li>Cab, Jet</li>
<li><em>Public</em>
<ul>
<li>Bus, Train</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="the-pay-uni--method" class="slide level2">
<h2>the <code>pay</code> Uni- Method</h2>
<pre class="c++`"><code>declare_method(double, pay, (virtual_&lt;Employee&amp;&gt;));

define_method(double, pay, (Employee&amp;)) {
  return 3000;
}

define_method(double, pay, (Manager&amp; manager)) {
  return next(manager) + 2000;
}</code></pre>
</section>
<section id="declare_method" class="slide level2">
<h2>declare_method</h2>
<div class="sourceCode" id="cb22"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true"></a>declare_method(<span class="dt">double</span>, pay, (<span class="va">virtual_</span>&lt;Employee&amp;&gt;));</span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true"></a><span class="kw">struct</span> YoMm2_S_pay;</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true"></a>yomm2::method&lt;</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true"></a>    YoMm2_S_pay, <span class="dt">double</span>(<span class="va">virtual_</span>&lt;<span class="at">const</span> Employee&amp;&gt;),</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true"></a>    yomm2::policy::default_policy&gt;</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true"></a><span class="va">pay_yOMM2_selector_</span>(</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true"></a>    yomm2::detail::remove_virtual&lt;<span class="va">virtual_</span>&lt;<span class="at">const</span> Employee&amp;&gt;&gt; a0);</span></code></pre></div>
</section>
<section id="declare_method-1" class="slide level2">
<h2>declare_method</h2>
<div class="sourceCode" id="cb24"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true"></a>declare_method(<span class="dt">double</span>, pay, (<span class="va">virtual_</span>&lt;Employee&amp;&gt;));</span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true"></a><span class="kw">inline</span> <span class="dt">double</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true"></a>pay(yomm2::detail::remove_virtual&lt;<span class="va">virtual_</span>&lt;<span class="at">const</span> Employee&amp;&gt;&gt; a0) {</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true"></a>    <span class="cf">return</span> yomm2::method&lt;</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true"></a>        YoMm2_S_pay, <span class="dt">double</span>(<span class="va">virtual_</span>&lt;<span class="at">const</span> Employee&amp;&gt;),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true"></a>        yomm2::policy::default_policy&gt;::</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true"></a>        fn(<span class="bu">std::</span>forward&lt;</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true"></a>            yomm2::detail::remove_virtual&lt;<span class="va">virtual_</span>&lt;<span class="at">const</span> Employee&amp;&gt;&gt;&gt;(</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true"></a>            a0));</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true"></a>};</span></code></pre></div>
</section>
<section id="define_method" class="slide level2">
<h2>define_method</h2>
<div class="sourceCode" id="cb26"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true"></a>define_method(<span class="dt">double</span>, pay, (Employee&amp;)) { <span class="cf">return</span> <span class="dv">3000</span>; }</span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true"></a><span class="kw">namespace</span> { <span class="kw">namespace</span> YoMm2_gS_10 {</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true"></a><span class="kw">template</span>&lt;<span class="kw">typename</span> T&gt; <span class="kw">struct</span> _yOMM2_select;</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true"></a><span class="kw">template</span>&lt;<span class="kw">typename</span>... A&gt; <span class="kw">struct</span> _yOMM2_select&lt;<span class="dt">void</span>(A...)&gt; {</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true"></a>    <span class="kw">using</span> type = <span class="kw">decltype</span>(<span class="va">pay_yOMM2_selector_</span>(<span class="bu">std::</span>declval&lt;A&gt;()...));</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true"></a>};</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true"></a><span class="kw">using</span> _yOMM2_method = _yOMM2_select&lt;<span class="dt">void</span>(<span class="at">const</span> Employee&amp;)&gt;::type;</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true"></a><span class="kw">using</span> _yOMM2_return_t = _yOMM2_method::<span class="dt">return_type</span>;</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true"></a>_yOMM2_method::<span class="dt">function_pointer_type</span> next;</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true"></a><span class="kw">struct</span> _yOMM2_spec {</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true"></a>    <span class="at">static</span> YoMm2_gS_10::_yOMM2_method::<span class="dt">return_type</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true"></a>    yOMM2_body(<span class="at">const</span> Employee&amp;);</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true"></a>};</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true"></a>_yOMM2_method::add_function&lt;_yOMM2_spec::yOMM2_body&gt;</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true"></a>    YoMm2_gS_11(&amp;next, <span class="kw">typeid</span>(_yOMM2_spec).name()); } }</span></code></pre></div>
</section>
<section id="define_method-1" class="slide level2">
<h2>define_method</h2>
<div class="sourceCode" id="cb28"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true"></a>define_method(<span class="dt">double</span>, pay, (Employee&amp;)) { <span class="cf">return</span> <span class="dv">3000</span>; }</span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true"></a>YoMm2_gS_10::_yOMM2_method::<span class="dt">return_type</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true"></a>YoMm2_gS_10::_yOMM2_spec::yOMM2_body(<span class="at">const</span> Employee&amp;) {</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true"></a>    <span class="cf">return</span> <span class="dv">3000</span>;</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true"></a>}</span></code></pre></div>
</section>
<section id="update_methods" class="slide level2">
<h2>update_methods</h2>
<p>Uses the class and method info registered by static ctors.</p>
<ul>
<li><p>build representation of class hierarchies</p></li>
<li><p>calculate the hash and dispatch tables</p></li>
<li><p>find a perfect (not minimal) hash function for the <code>type_info</code>s</p>
<ul>
<li>H(x) = (M * x) &gt;&gt; S</li>
</ul></li>
</ul>
</section>
<section id="dispatching-a-uni-method" class="slide level2">
<h2>Dispatching a Uni-Method</h2>
<ul>
<li><p>pretty much like virtual member functions</p></li>
<li><p>method table contains a pointer to the effective function</p></li>
<li><p>only it is not at a fixed offset in the method table</p></li>
</ul>
</section>
<section id="dispatching-a-uni-method-1" class="slide level2">
<h2>Dispatching a Uni-Method</h2>
<p>during <code>update_methods</code></p>
<div class="sourceCode" id="cb30"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true"></a>method&lt;pay&gt;::slots_strides.i = <span class="dv">1</span>;</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true"></a><span class="co">// method table for Employee</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true"></a>mtbls[ H(&amp;<span class="kw">typeid</span>(Employee)) ] = {</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true"></a>  ..., <span class="co">// used by approve,</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true"></a>  wrapper(pay(Employee&amp;))</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true"></a>};</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true"></a><span class="co">// method table for Manager</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true"></a>mtbls[ H(&amp;<span class="kw">typeid</span>(Manager&amp;)) ] = {</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true"></a>  ..., <span class="co">// used by approve,</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true"></a>  wrapper(pay(Manager&amp;))</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true"></a>};</span></code></pre></div>
</section>
<section id="dispatching-a-uni-method-2" class="slide level2">
<h2>Dispatching a Uni-Method</h2>
<div class="sourceCode" id="cb31"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true"></a>pay(bill)</span></code></pre></div>
<p>=&gt;</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true"></a>mtbls[ H(&amp;<span class="kw">typeid</span>(bill)) ]          <span class="co">// mtable for type</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true"></a>  [ method&lt;pay&gt;::slots_strides.i ] <span class="co">// pointer to fun</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true"></a>(bill)                             <span class="co">// call</span></span></code></pre></div>
</section>
<section id="assembler" class="slide level2">
<h2>Assembler</h2>
<div class="sourceCode" id="cb33"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true"></a><span class="dt">double</span> call_pay(Employee&amp; e) { <span class="cf">return</span> pay(e); }</span></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="sourceCode asm"><code class="sourceCode fasm"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true"></a><span class="bu">mov</span> <span class="kw">r8</span>, <span class="dt">qword</span> <span class="dt">ptr</span> [rip + context+<span class="dv">24</span>]              <span class="co">; hash table</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true"></a><span class="bu">mov</span> <span class="kw">rdx</span>, <span class="dt">qword</span> <span class="dt">ptr</span> [rip + context+<span class="dv">32</span>]             <span class="co">; M</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true"></a><span class="bu">mov</span> <span class="kw">cl</span>, <span class="dt">byte</span> <span class="dt">ptr</span> [rip + context+<span class="dv">40</span>]               <span class="co">; S</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true"></a><span class="bu">movsxd</span> <span class="kw">rsi</span>, <span class="dt">dword</span> <span class="dt">ptr</span> [rip + method&lt;pay&gt;::fn+<span class="dv">96</span>]  <span class="co">; slot</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true"></a><span class="bu">mov</span> <span class="kw">rax</span>, <span class="dt">qword</span> <span class="dt">ptr</span> [<span class="kw">rdi</span>]                          <span class="co">; vptr</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true"></a><span class="bu">imul</span> <span class="kw">rdx</span>, <span class="dt">qword</span> <span class="dt">ptr</span> [<span class="kw">rax</span> - <span class="dv">8</span>]                     <span class="co">; M * &amp;typeid(e)</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true"></a><span class="bu">shr</span> <span class="kw">rdx</span>, <span class="kw">cl</span>                                       <span class="co">; &gt;&gt; S</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true"></a><span class="bu">mov</span> <span class="kw">rax</span>, <span class="dt">qword</span> <span class="dt">ptr</span> [<span class="kw">r8</span> + <span class="dv">8</span>*<span class="kw">rdx</span>]                   <span class="co">; method table</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true"></a><span class="bu">jmp</span> <span class="dt">qword</span> <span class="dt">ptr</span> [<span class="kw">rax</span> + <span class="dv">8</span>*<span class="kw">rsi</span>]                       <span class="co">; call wrapper</span></span></code></pre></div>
</section>
<section id="approve-multi-method" class="slide level2">
<h2><code>approve</code> Multi-Method</h2>
<div class="sourceCode" id="cb35"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true"></a>declare_method(<span class="dt">bool</span>, approve,</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true"></a>  (<span class="va">virtual_</span>&lt;Role&amp;&gt;, <span class="va">virtual_</span>&lt;Expense&amp;&gt;, <span class="dt">double</span>));</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true"></a>define_method(<span class="dt">bool</span>, approve,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true"></a>  (Role&amp; r, Expense&amp; e, <span class="dt">double</span> amount))    { <span class="cf">return</span> <span class="kw">false</span>; }</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true"></a>define_method(<span class="dt">bool</span>, approve,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true"></a>  (Employee&amp; r, Public&amp; e, <span class="dt">double</span> amount)) { <span class="cf">return</span> <span class="kw">true</span>; }</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true"></a>define_method(<span class="dt">bool</span>, approve,</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true"></a>  (Manager&amp; r, Taxi&amp; e, <span class="dt">double</span> amount))    { <span class="cf">return</span> <span class="kw">true</span>; }</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true"></a>define_method(<span class="dt">bool</span>, approve,</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true"></a>  (Founder&amp; r, Expense&amp; e, <span class="dt">double</span> amount)) { <span class="cf">return</span> <span class="kw">true</span>; }</span></code></pre></div>
</section>
<section id="dispatching-a-multi-method" class="slide level2">
<h2>Dispatching a Multi-Method</h2>
<ul>
<li><p>it’s a little more complicated</p></li>
<li><p>use a multi-dimensional dispatch table</p></li>
<li><p>size can grow very quickly</p></li>
<li><p>the table must be “compressed”, devoid of redundancies</p></li>
<li><p>in fact the “uncompressed” table never exists</p></li>
<li><p>work in terms of class <em>groups</em>, not classes</p></li>
</ul>
</section>
<section id="dispatching-a-multi-method-1" class="slide level2">
<h2>Dispatching a Multi-Method</h2>
<table>
<thead>
<tr class="header">
<th></th>
<th style="text-align: center;">Expense+Jet</th>
<th style="text-align: center;">Public+Bus+Train</th>
<th style="text-align: center;">Cab</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Role</td>
<td style="text-align: center;">R,X</td>
<td style="text-align: center;">R,X</td>
<td style="text-align: center;">R,X</td>
</tr>
<tr class="even">
<td>Employee</td>
<td style="text-align: center;">R,X</td>
<td style="text-align: center;">E,P</td>
<td style="text-align: center;">R,X</td>
</tr>
<tr class="odd">
<td>Manager</td>
<td style="text-align: center;">R,X</td>
<td style="text-align: center;">E,P</td>
<td style="text-align: center;">M,C</td>
</tr>
<tr class="even">
<td>Founder</td>
<td style="text-align: center;">F,X</td>
<td style="text-align: center;">F,X</td>
<td style="text-align: center;">F,X</td>
</tr>
</tbody>
</table>
<p>(column major)</p>
</section>
<section id="building-the-compressed-dispatch-table" class="slide level2">
<h2>Building the Compressed Dispatch Table</h2>
<ul>
<li><p><a href="https://hal.inria.fr/inria-00073721/document">Fast Algorithms for Compressed Multi-Method Dispatch, Eric Amiel, Eric Dujardin, Eric Simon, 1996</a></p></li>
<li><p><a href="https://www.codeproject.com/Articles/859492/Open-Multi-Methods-for-Cplusplus-Part-Inside-Yomm">Open Multi-Methods for C++11, Part 3 - Inside Yomm11: Data Structures and Algorithms, Jean-Louis Leroy, 2013</a></p></li>
</ul>
</section>
<section id="dispatching-a-multi-method-2" class="slide level2">
<h2>Dispatching a Multi-Method</h2>
<div class="sourceCode" id="cb36"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true"></a>method&lt;approve&gt;::.slots_strides.pw = { <span class="dv">0</span>, <span class="dv">4</span>, <span class="dv">0</span> };</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true"></a>mtbls[ H(&amp;<span class="kw">typeid</span>(Employee)) ] = {</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true"></a>  <span class="co">// &amp; of (Employee,Expense+Jet) cell</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true"></a>  <span class="co">// used by pay</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true"></a>};</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true"></a>mtbls[ H(&amp;<span class="kw">typeid</span>(Manager)) ] = {</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true"></a>  <span class="co">// &amp; of (Manager,Expense+Jet) cell</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true"></a>  <span class="co">// used by pay</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true"></a>};</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true"></a></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true"></a>mtbls[ H(&amp;<span class="kw">typeid</span>(Expense)) ] = { <span class="dv">0</span> }; <span class="co">// also for Jet</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true"></a>mtbls[ H(&amp;<span class="kw">typeid</span>(Public))  ] = { <span class="dv">1</span> }; <span class="co">// also for Bus, Train</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true"></a>mtbls[ H(&amp;<span class="kw">typeid</span>(Cab))     ] = { <span class="dv">2</span> };</span></code></pre></div>
</section>
<section id="dispatching-a-multi-method-3" class="slide level2">
<h2>Dispatching a Multi-Method</h2>
<div class="sourceCode" id="cb37"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true"></a>approve(bill, ticket, <span class="dv">5000</span>)</span></code></pre></div>
<p>=&gt;</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode c++"><code class="sourceCode cpp"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true"></a>word* slots_strides = method&lt;approve&gt;::.slots_strides.pw;</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true"></a>mtbls[ H(&amp;<span class="kw">typeid</span>(bill)) ]        <span class="co">// method table for bill</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true"></a>  [ slots_strides[<span class="dv">0</span>].i ]         <span class="co">// ptr to cell in 1st column</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true"></a>  [ mtbls [ H(&amp;<span class="kw">typeid</span>(ticket)) ] <span class="co">// method table for ticket</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true"></a>    [ slots_strides[<span class="dv">2</span>].i ]       <span class="co">// column</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true"></a>    * slots_strides[<span class="dv">1</span>].i         <span class="co">// stride</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true"></a>  ]                              <span class="co">// pointer to function</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true"></a>(bill, ticket, <span class="dv">5000</span>)             <span class="co">// call</span></span></code></pre></div>
</section>
<section id="benchmarks" class="slide level2">
<h2>Benchmarks</h2>
<table>
<thead>
<tr class="header">
<th></th>
<th></th>
<th>gcc6</th>
<th>clang6</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>normal inheritance</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>virtual function</td>
<td>1-method</td>
<td>16%</td>
<td>17%</td>
</tr>
<tr class="odd">
<td>double dispatch</td>
<td>2-method</td>
<td>25%</td>
<td>35%</td>
</tr>
<tr class="even">
<td>virtual inheritance</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>virtual function</td>
<td>1-method</td>
<td>19%</td>
<td>17%</td>
</tr>
<tr class="even">
<td>double dispatch</td>
<td>2-method</td>
<td>40%</td>
<td>33%</td>
</tr>
</tbody>
</table>
</section>
<section id="yomm2-vs-other-systems" class="slide level2">
<h2>yomm2 vs other systems</h2>
<ul>
<li>Pirkelbauer - Solodkyi - Stroustrup (PSS)</li>
<li>yomm11</li>
<li>Cmm</li>
<li>Loki / Modern C++</li>
</ul>
</section>
<section id="yomm2-vs-pss" class="slide level2">
<h2>yomm2 vs PSS</h2>
<ul>
<li>Solodkyi’s papers on open methods etc:
<ul>
<li><a href="http://www.stroustrup.com/multimethods.pdf">Open Multi-Methods for C++</a></li>
<li><a href="https://parasol.tamu.edu/~yuriys/papers/OMM10.pdf">Design and Evaluation of C++ Open Multi-Methods</a></li>
<li><a href="http://oaktrust.library.tamu.edu/bitstream/handle/1969.1/151376/SOLODKYY-DISSERTATION-2013.pdf">Simplifying the Analysis of C++ Programs</a></li>
</ul></li>
<li>PSS attempts harder to resolve ambiguities</li>
<li>yomm2 overrides not visible as overloads, cannot specialize multiple methods</li>
<li>yomm2 supports smart pointers, <code>next</code></li>
</ul>
</section>
<section id="yomm2-vs-yomm11" class="slide level2">
<h2>yomm2 vs yomm11</h2>
<ul>
<li><p>no need to instrument classes</p></li>
<li><p>methods are ordinary functions</p></li>
</ul>
</section></section>
<section id="roadmap" class="title-slide slide level1">
<h1>Roadmap</h1>
<ul>
<li><code>virtual_ptr</code> (fat pointer)</li>
<li>intrusive mode</li>
<li>dispatch on <code>std::any</code></li>
<li>header-only</li>
<li>tunable runtime</li>
<li>allocators (surprised?)</li>
<li>“static” mode</li>
</ul>
</section>

<section id="qa-time" class="title-slide slide level1">
<h1>QA Time</h1>
<ul>
<li>github: https://github.com/jll63/yomm2</li>
<li>contact: Jean-Louis Leroy - jl@leroy.nyc</li>
</ul>
<center>
<img src="qr.png" />
</center>
</section>
    </div>
  </div>

  <script src="https://unpkg.com/reveal.js@3.9.2//js/reveal.js"></script>

  <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        // Push each slide change to the browser history
        history: true,
        // Vertical centering of slides
        center: false,

        // Optional reveal.js plugins
        dependencies: [
          { src: 'https://unpkg.com/reveal.js@3.9.2//lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'https://unpkg.com/reveal.js@3.9.2//plugin/zoom-js/zoom.js', async: true },
          { src: 'https://unpkg.com/reveal.js@3.9.2//plugin/notes/notes.js', async: true }
        ]
      });
    </script>
    </body>
</html>
